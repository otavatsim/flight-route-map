<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orca Transport Association – Airports & Routes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.17.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.17.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
</head>
<body class="bg-white text-gray-800">
  <header class="bg-green-600 text-white p-4 text-xl font-bold">
    Orca Transport Association – Airports & Routes
  </header>

  <main class="p-4">
    <div id="map" class="w-full h-[800px] rounded shadow"></div>
  </main>

  <footer class="bg-green-700 text-white p-4 text-center">
    © 2025 Orca Transport Association
  </footer>

  <script>
    mapboxgl.accessToken =
      "pk.eyJ1Ijoiam9iczEwMDAwIiwiYSI6ImNtZGh0b3NuNTA1ZHQya3NidHp2bTVoZXcifQ.Yhw63MxR-rZ2MEbsDOVjtQ";

    const routes = [
      { from: "DCA", to: "LAX", frequency: "5 flights/day", operator: "OTA Airlines" },
      { from: "SEA", to: "SFO", frequency: "3 flights/day", operator: "OTA Airlines" }
    ];

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      center: [0, 20],
      zoom: 2
    });

    map.on("load", async () => {
      // --- Airports Source ---
      const response = await fetch("airports.json");
      const airportsData = await response.json();

      map.addSource("airports", {
        type: "geojson",
        data: {
          type: "FeatureCollection",
          features: airportsData.map(a => ({
            type: "Feature",
            properties: { code: a.code, name: a.name },
            geometry: { type: "Point", coordinates: [a.lon, a.lat] }
          }))
        },
        cluster: true,
        clusterMaxZoom: 12,
        clusterRadius: 40
      });

      // Cluster layer
      map.addLayer({
        id: "clusters",
        type: "circle",
        source: "airports",
        filter: ["has", "point_count"],
        paint: {
          "circle-color": "#2F855A",
          "circle-radius": ["step", ["get", "point_count"], 15, 100, 20, 750, 25]
        }
      });

      // Count labels
      map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "airports",
        filter: ["has", "point_count"],
        layout: {
          "text-field": "{point_count_abbreviated}",
          "text-size": 12
        }
      });

      // Unclustered airports
      map.addLayer({
        id: "unclustered-point",
        type: "circle",
        source: "airports",
        filter: ["!", ["has", "point_count"]],
        paint: {
          "circle-color": "#2F855A",
          "circle-radius": 5,
          "circle-stroke-width": 1,
          "circle-stroke-color": "#fff"
        }
      });

      // Popup for single airport
      map.on("click", "unclustered-point", e => {
        const coords = e.features[0].geometry.coordinates.slice();
        const { code, name } = e.features[0].properties;
        new mapboxgl.Popup().setLngLat(coords).setHTML(`<b>${code}</b><br>${name}`).addTo(map);
      });

      // Zoom on cluster click
      map.on("click", "clusters", e => {
        const features = map.queryRenderedFeatures(e.point, { layers: ["clusters"] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource("airports").getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (!err) {
            map.easeTo({ center: features[0].geometry.coordinates, zoom });
          }
        });
      });

      // --- Draw routes ---
      routes.forEach((r, i) => {
        const from = airportsData.find(a => a.code === r.from);
        const to = airportsData.find(a => a.code === r.to);
        if (!from || !to) return;
        const line = turf.greatCircle([from.lon, from.lat], [to.lon, to.lat], { npoints: 64 });
        const srcId = `route-${i}`;
        map.addSource(srcId, { type: "geojson", data: line });
        map.addLayer({
          id: `route-layer-${i}`,
          type: "line",
          source: srcId,
          layout: { "line-cap": "round", "line-join": "round" },
          paint: { "line-color": "#2F855A", "line-width": 3 }
        });
      });

      map.on("mouseenter", "clusters", () => (map.getCanvas().style.cursor = "pointer"));
      map.on("mouseleave", "clusters", () => (map.getCanvas().style.cursor = ""));
    });
  </script>
</body>
</html>
